- name: nancurunir
  hosts: all
  become: yes
  vars_prompt:
  - name: deployer_pass
    prompt: what is the deployer's password for mysql?
    private: yes
  - name: gandalfsqlpass
    prompt: what do you want gandalf's mysql password to be?
    private: yes

  tasks:
    - name: set the hostname
      hostname:
        name: "{{hostname}}"
      
    - name: set the root password
      user:
        name: root
        password: "{{root_hash}}"
        state: present
        create_home: yes
    
    - name: create unprivileged user
      user:
        name: "{{user_name}}"
        password: "{{user_hash}}"
        state: present
        create_home: yes
      

    - name: drop the root flag
      copy:
        dest: "/root/root-flag.txt"
        content: |
          "{{root_flag}}"
        owner: root
        group: root

    - name: create gandalf mysql user
      mysql_query:
        login_user: deployer
        login_password: "{{deployer_pass}}"
        query: 
        - CREATE USER 'gandalf'@'localhost' IDENTIFIED BY '{{gandalfsqlpass}}';
        - GRANT ALL PRIVILEGES ON * . * TO 'gandalf'@'localhost';
        - DROP USER 'deployer'@'localhost';
        - FLUSH PRIVILEGES;

    - name: drop the user flag
      copy:
        dest: "/home/{{user_name}}/user-flag.txt"
        content: |
          "{{user_flag}}"
        owner: "{{user_name}}"
        group: "{{user_name}}"

    - name: upload index
      copy:
        src: "files/index.html"
        dest: "/var/www/html/index.html"
        owner: www-data
        group: www-data

    - name: fix permissions for index.html
      shell: sudo chmod -R 622 /var/www/html/index.html

    - name: unarchive phpMyAdmin 4.8.1
      unarchive:
        src: "files/phpMyAdmin-4.8.1-all-languages.tar.gz"
        dest: "/home/deployer/"

    - name: copy phpMyAdmin directory
      shell: mv /home/deployer/phpMyAdmin-4.8.1-all-languages /usr/share/phpmyadmin

    - name: change owner of phpMyAdmin directory
      shell: sudo chown -R www-data /usr/share/phpmyadmin

    - name: change permissions of phpMyAdmin directory
      shell: sudo chmod -R 755 /usr/share/phpmyadmin

    - name: copy phpMyAdmin config file
      copy:
        src: "files/phpmyadmin.conf"
        dest: "/etc/apache2/conf-available/phpmyadmin.conf"

    - name: copy php.ini file
      copy:
        src: "files/php.ini"
        dest: "/etc/php/7.4/apache2/php.ini"

    - name: enable phpmyadmin config
      shell: sudo a2enconf phpmyadmin

    - name: misconfigure /etc/passwd permissions
      shell: sudo chmod 777 /etc/passwd

    - name: reboot the box to change hostname
      reboot:
